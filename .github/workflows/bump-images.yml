# Manually triggered pipeline to bump NeuralTrust image versions.
# Updates: values.yaml, template hardcoded fallbacks, subchart defaults,
# and bumps chart versions (patch).
#
# For each image, provide a specific tag or leave empty to auto-detect
# the latest release from Google Artifact Registry.
#
# Usage:
#   1. Go to Actions → "Bump Image Versions" → Run workflow
#   2. Fill in specific tags or leave empty for auto-detection
#   3. The workflow creates a PR with the version changes

name: Bump Image Versions

on:
  workflow_dispatch:
    inputs:
      trustgate_tag:
        description: "trustgate-ee tag (e.g. v1.9.51). Empty = latest from AR."
        required: false
        default: ""
      control_plane_api_tag:
        description: "control-plane-api tag (e.g. v1.8.3). Empty = latest from AR."
        required: false
        default: ""
      scheduler_tag:
        description: "scheduler tag (e.g. v1.8.1). Empty = latest from AR."
        required: false
        default: ""
      app_tag:
        description: "app (frontend) tag (e.g. v1.8.1). Empty = latest from AR."
        required: false
        default: ""
      data_plane_api_tag:
        description: "data-plane-api tag (e.g. v1.8.4). Empty = latest from AR."
        required: false
        default: ""
      workers_tag:
        description: "workers tag (e.g. v1.5.0). Empty = latest from AR."
        required: false
        default: ""
      kafka_connect_tag:
        description: "kafka-connect tag (e.g. v0.0.2). Empty = latest from AR."
        required: false
        default: ""
      fetch_latest:
        description: "Fetch latest from Artifact Registry for empty inputs"
        required: false
        type: boolean
        default: true

env:
  AR_REGISTRY: europe-west1-docker.pkg.dev
  AR_PROJECT: neuraltrust-app-prod
  AR_REPO: nt-docker

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Resolve image tags
        id: tags
        run: |
          AR_BASE="${{ env.AR_REGISTRY }}/${{ env.AR_PROJECT }}/${{ env.AR_REPO }}"
          FETCH_LATEST="${{ inputs.fetch_latest }}"

          resolve_tag() {
            local image="$1"
            local manual_tag="$2"

            if [[ -n "$manual_tag" ]]; then
              echo "$manual_tag"
              return
            fi

            if [[ "$FETCH_LATEST" != "true" ]]; then
              echo ""
              return
            fi

            echo "Fetching latest tag for ${image}..." >&2

            local latest
            latest=$(gcloud artifacts docker tags list \
              "${AR_BASE}/${image}" \
              --format='value(tag)' 2>&1)

            if [[ $? -ne 0 ]]; then
              echo "ERROR: gcloud failed for ${image}: ${latest}" >&2
              echo ""
              return
            fi

            # Filter for semver tags (v*) and sort by version number
            latest=$(echo "$latest" | grep -E '^v[0-9]' | sort -V | tail -1)

            if [[ -z "$latest" ]]; then
              echo "WARNING: Could not find latest tag for ${image}" >&2
              echo ""
              return
            fi

            echo "  → ${image}: ${latest}" >&2
            echo "$latest"
          }

          TRUSTGATE=$(resolve_tag "trustgate-ee" "${{ inputs.trustgate_tag }}")
          CONTROL_PLANE_API=$(resolve_tag "control-plane-api" "${{ inputs.control_plane_api_tag }}")
          SCHEDULER=$(resolve_tag "scheduler" "${{ inputs.scheduler_tag }}")
          APP=$(resolve_tag "app" "${{ inputs.app_tag }}")
          DATA_PLANE_API=$(resolve_tag "data-plane-api" "${{ inputs.data_plane_api_tag }}")
          WORKERS=$(resolve_tag "workers" "${{ inputs.workers_tag }}")
          KAFKA_CONNECT=$(resolve_tag "kafka-connect" "${{ inputs.kafka_connect_tag }}")

          echo "trustgate=${TRUSTGATE}" >> "$GITHUB_OUTPUT"
          echo "control_plane_api=${CONTROL_PLANE_API}" >> "$GITHUB_OUTPUT"
          echo "scheduler=${SCHEDULER}" >> "$GITHUB_OUTPUT"
          echo "app=${APP}" >> "$GITHUB_OUTPUT"
          echo "data_plane_api=${DATA_PLANE_API}" >> "$GITHUB_OUTPUT"
          echo "workers=${WORKERS}" >> "$GITHUB_OUTPUT"
          echo "kafka_connect=${KAFKA_CONNECT}" >> "$GITHUB_OUTPUT"

          echo "### Resolved Tags" >> "$GITHUB_STEP_SUMMARY"
          echo "| Image | Tag |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|-----|" >> "$GITHUB_STEP_SUMMARY"
          echo "| trustgate-ee | \`${TRUSTGATE:-skipped}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| control-plane-api | \`${CONTROL_PLANE_API:-skipped}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| scheduler | \`${SCHEDULER:-skipped}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| app | \`${APP:-skipped}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| data-plane-api | \`${DATA_PLANE_API:-skipped}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| workers | \`${WORKERS:-skipped}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| kafka-connect | \`${KAFKA_CONNECT:-skipped}\` |" >> "$GITHUB_STEP_SUMMARY"

      - name: Update values.yaml and template defaults
        id: update
        run: |
          CHANGES=()
          BUMP_CONTROL_PLANE=false
          BUMP_DATA_PLANE=false
          BUMP_TRUSTGATE=false

          # --- Helper: update a tag in values.yaml via yq ---
          update_values_tag() {
            local yq_path="$1"
            local new_tag="$2"
            local image_name="$3"
            local file="${4:-values.yaml}"

            if [[ -z "$new_tag" ]]; then
              return 1
            fi

            local current_tag
            current_tag=$(yq eval "${yq_path}" "$file")

            if [[ "$current_tag" == "$new_tag" ]]; then
              echo "No change for ${image_name} in ${file} (already ${current_tag})"
              return 1
            fi

            echo "Updating ${image_name} in ${file}: ${current_tag} → ${new_tag}"
            yq eval -i "${yq_path} = \"${new_tag}\"" "$file"
            CHANGES+=("${image_name}: ${current_tag} → ${new_tag}")
            return 0
          }

          # --- Helper: update hardcoded fallback tag in a Go template file ---
          # Handles both patterns:
          #   {{- $var := "TAG" }}                        (control-plane style)
          #   {{- $var := .Values.path | default "TAG" }} (data-plane style)
          update_template_tag() {
            local file="$1"
            local var_name="$2"
            local new_tag="$3"

            if [[ -z "$new_tag" ]]; then
              return
            fi

            if grep -q "\$${var_name} :=" "$file" 2>/dev/null; then
              # Pattern: {{- $var := "OLD" }}
              sed -i "s/\(\$${var_name} := \)\"[^\"]*\"/\1\"${new_tag}\"/" "$file"
              # Pattern: {{- $var := .Values.xxx | default "OLD" }}
              sed -i "s/\(\$${var_name} := .*| default \)\"[^\"]*\"/\1\"${new_tag}\"/" "$file"
              echo "  Updated fallback \$${var_name} → ${new_tag} in ${file}"
            fi
          }

          # --- Helper: bump patch version in a Chart.yaml ---
          bump_chart_version() {
            local chart_file="$1"
            local current
            current=$(yq eval '.version' "$chart_file")
            local major minor patch
            IFS='.' read -r major minor patch <<< "$current"
            patch=$((patch + 1))
            local new_version="${major}.${minor}.${patch}"
            yq eval -i ".version = \"${new_version}\"" "$chart_file"
            echo "  Bumped ${chart_file}: ${current} → ${new_version}" >&2
            echo "${new_version}"
          }

          # =============================================
          # 1. TrustGate EE
          # =============================================
          TAG="${{ steps.tags.outputs.trustgate }}"
          if update_values_tag '.trustgate.global.image.tag' "$TAG" "trustgate-ee"; then
            BUMP_TRUSTGATE=true
            # Sync trustgate subchart default values
            yq eval -i ".global.image.tag = \"${TAG}\"" charts/trustgate/values.yaml
            echo "  Synced charts/trustgate/values.yaml"
          fi

          # =============================================
          # 2. Control Plane API
          # =============================================
          TAG="${{ steps.tags.outputs.control_plane_api }}"
          if update_values_tag '.["neuraltrust-control-plane"].controlPlane.components.api.image.tag' "$TAG" "control-plane-api"; then
            BUMP_CONTROL_PLANE=true
            update_template_tag "charts/neuraltrust-control-plane/templates/api/deployment.yaml" "apiImageTag" "$TAG"
          fi

          # =============================================
          # 3. Scheduler
          # =============================================
          TAG="${{ steps.tags.outputs.scheduler }}"
          if update_values_tag '.["neuraltrust-control-plane"].controlPlane.components.scheduler.image.tag' "$TAG" "scheduler"; then
            BUMP_CONTROL_PLANE=true
            update_template_tag "charts/neuraltrust-control-plane/templates/scheduler/deployment.yaml" "imageTag" "$TAG"
          fi

          # =============================================
          # 4. App (frontend) — updates both initContainer and main container
          # =============================================
          TAG="${{ steps.tags.outputs.app }}"
          if update_values_tag '.["neuraltrust-control-plane"].controlPlane.components.app.image.tag' "$TAG" "app"; then
            BUMP_CONTROL_PLANE=true
            update_template_tag "charts/neuraltrust-control-plane/templates/app/deployment.yaml" "initImageTag" "$TAG"
            update_template_tag "charts/neuraltrust-control-plane/templates/app/deployment.yaml" "appImageTag" "$TAG"
          fi

          # =============================================
          # 5. Data Plane API
          # =============================================
          TAG="${{ steps.tags.outputs.data_plane_api }}"
          if update_values_tag '.["neuraltrust-data-plane"].dataPlane.components.api.image.tag' "$TAG" "data-plane-api"; then
            BUMP_DATA_PLANE=true
            update_template_tag "charts/neuraltrust-data-plane/templates/api/deployment.yaml" "apiTag" "$TAG"
          fi

          # =============================================
          # 6. Workers
          # =============================================
          TAG="${{ steps.tags.outputs.workers }}"
          if update_values_tag '.["neuraltrust-data-plane"].dataPlane.components.worker.image.tag' "$TAG" "workers"; then
            BUMP_DATA_PLANE=true
            update_template_tag "charts/neuraltrust-data-plane/templates/worker/deployment.yaml" "workerTag" "$TAG"
          fi

          # =============================================
          # 7. Kafka Connect
          # =============================================
          TAG="${{ steps.tags.outputs.kafka_connect }}"
          if update_values_tag '.["neuraltrust-data-plane"].dataPlane.components.kafka.connect.image.tag' "$TAG" "kafka-connect"; then
            BUMP_DATA_PLANE=true
            update_template_tag "charts/neuraltrust-data-plane/templates/kafka-components/deployment.yaml" "kafkaConnectTag" "$TAG"
          fi

          # =============================================
          # Bump chart versions (patch) for changed subcharts
          # =============================================
          echo ""
          echo "=== Chart Version Bumps ==="

          # Bump subchart versions (patch) and sync dependency refs in root Chart.yaml
          # Note: root chart VERSION is handled by auto-release.yml on merge
          if [[ "$BUMP_CONTROL_PLANE" == "true" ]]; then
            NEW_VER=$(bump_chart_version "charts/neuraltrust-control-plane/Chart.yaml")
            yq eval -i "(.dependencies[] | select(.name == \"neuraltrust-control-plane\")).version = \"${NEW_VER}\"" Chart.yaml
            echo "  Updated root Chart.yaml dep: neuraltrust-control-plane → ${NEW_VER}"
          fi

          if [[ "$BUMP_DATA_PLANE" == "true" ]]; then
            NEW_VER=$(bump_chart_version "charts/neuraltrust-data-plane/Chart.yaml")
            yq eval -i "(.dependencies[] | select(.name == \"neuraltrust-data-plane\")).version = \"${NEW_VER}\"" Chart.yaml
            echo "  Updated root Chart.yaml dep: neuraltrust-data-plane → ${NEW_VER}"
          fi

          if [[ "$BUMP_TRUSTGATE" == "true" ]]; then
            NEW_VER=$(bump_chart_version "charts/trustgate/Chart.yaml")
            yq eval -i "(.dependencies[] | select(.name == \"trustgate\")).version = \"${NEW_VER}\"" Chart.yaml
            echo "  Updated root Chart.yaml dep: trustgate → ${NEW_VER}"
          fi

          # Save changes summary
          if [[ ${#CHANGES[@]} -eq 0 ]]; then
            echo "NO_CHANGES=true" >> "$GITHUB_ENV"
            echo "No version changes needed."
          else
            echo "NO_CHANGES=false" >> "$GITHUB_ENV"
            {
              echo "CHANGES_SUMMARY<<EOF"
              for c in "${CHANGES[@]}"; do echo "- ${c}"; done
              echo "EOF"
            } >> "$GITHUB_ENV"
          fi

      - name: Regenerate Chart.lock
        if: env.NO_CHANGES != 'true'
        run: |
          helm dependency update .
          echo "Chart.lock regenerated"

      - name: Check for changes
        if: env.NO_CHANGES != 'true'
        id: diff
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "### Changes" >> "$GITHUB_STEP_SUMMARY"
            echo '```diff' >> "$GITHUB_STEP_SUMMARY"
            git diff >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Create Pull Request
        if: env.NO_CHANGES != 'true' && steps.diff.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="chore/bump-images-$(date +%Y%m%d-%H%M%S)"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "$(cat <<'COMMIT'
          chore: bump image versions

          ${{ env.CHANGES_SUMMARY }}
          COMMIT
          )"
          git push origin "$BRANCH"

          gh pr create \
            --title "chore: bump image versions" \
            --body "$(cat <<PR_BODY
          ## Image Version Bump

          Triggered by: @${{ github.actor }}
          Mode: ${{ inputs.fetch_latest == true && 'auto-detect latest from Artifact Registry' || 'manual input' }}

          ### Changes
          ${{ env.CHANGES_SUMMARY }}

          ---
          *Auto-generated by [Bump Image Versions](/${{ github.repository }}/actions/workflows/bump-images.yml) workflow*
          PR_BODY
          )" \
            --base main \
            --head "$BRANCH"

      - name: No changes summary
        if: env.NO_CHANGES == 'true' || steps.diff.outputs.has_changes == 'false'
        run: |
          echo "### No Changes" >> "$GITHUB_STEP_SUMMARY"
          echo "All images are already at the requested versions." >> "$GITHUB_STEP_SUMMARY"
