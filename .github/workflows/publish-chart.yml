name: Publish Helm Chart to Artifact Registry

on:
  release:
    types: [published]

# Artifact Registry (gcr.io does not support OCI Helm: 404 "Repository gcr.io not found")
env:
  AR_REGISTRY: europe-west1-docker.pkg.dev
  AR_LOCATION: europe-west1
  AR_REPO: helm-charts
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  CHART_NAME: neuraltrust-platform

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || github.ref }}
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS"
          gcloud auth configure-docker ${{ env.AR_REGISTRY }} --quiet

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Extract Chart Version
        id: chart_version
        run: |
          if [ -n "${{ github.ref }}" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Extract version from git tag (remove 'v' prefix if present)
            CHART_VERSION="${GITHUB_REF#refs/tags/}"
            CHART_VERSION="${CHART_VERSION#v}"
          else
            # Read version from Chart.yaml
            CHART_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}' | tr -d '"')
          fi
          echo "version=$CHART_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Chart version: $CHART_VERSION"

      - name: Validate Chart
        run: |
          echo "ðŸ” Validating Helm chart..."
          helm lint .
          helm dependency list

      - name: Package Chart
        run: |
          echo "ðŸ“¦ Packaging Helm chart with fresh dependencies..."
          helm package . --dependency-update --version ${{ steps.chart_version.outputs.version }}
          CHART_FILE=$(ls neuraltrust-platform-*.tgz)
          echo "CHART_FILE=$CHART_FILE" >> $GITHUB_ENV
          echo "âœ… Packaged: $CHART_FILE"

      - name: Authenticate to Artifact Registry
        run: |
          echo "ðŸ” Authenticating to Artifact Registry..."
          gcloud auth configure-docker ${{ env.AR_REGISTRY }} --quiet
          # Helm OCI does not use Docker's credential helper; log in explicitly
          gcloud auth print-access-token | helm registry login -u oauth2accesstoken --password-stdin ${{ env.AR_REGISTRY }}

      - name: Push Chart to Artifact Registry
        id: push_chart
        run: |
          set -o pipefail
          echo "ðŸš€ Pushing chart to Artifact Registry..."
          helm push ${{ env.CHART_FILE }} oci://${{ env.AR_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }} 2>&1 | tee push_output.txt
          echo "âœ… Chart pushed successfully!"
          
          # Extract digest from push output if available
          if grep -q "digest:" push_output.txt; then
            DIGEST=$(grep "digest:" push_output.txt | awk '{print $2}' | cut -d: -f2)
            echo "digest=$DIGEST" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Chart digest: $DIGEST"
          fi

      - name: Make Chart Public (Open Source)
        run: |
          echo "ðŸŒ Making chart publicly accessible (open source)..."
          if gcloud artifacts repositories add-iam-policy-binding ${{ env.AR_REPO }} \
            --location=${{ env.AR_LOCATION }} \
            --project=${{ env.PROJECT_ID }} \
            --member=allUsers \
            --role=roles/artifactregistry.reader 2>/dev/null; then
            echo "âœ… Chart repository made public successfully!"
          else
            echo "âš ï¸  Automatic public access failed (org policy may block allUsers)."
            echo "To make the chart public manually, run:"
            echo "  gcloud artifacts repositories add-iam-policy-binding ${{ env.AR_REPO }} --location=${{ env.AR_LOCATION }} --member=allUsers --role=roles/artifactregistry.reader"
          fi
          CHART_REF="oci://${{ env.AR_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.CHART_NAME }}"
          echo "   Test with: helm pull $CHART_REF --version ${{ steps.chart_version.outputs.version }}"

      - name: Tag as Latest (if applicable)
        if: github.event_name == 'release' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
        run: |
          echo "ðŸ·ï¸  Latest version: ${{ steps.chart_version.outputs.version }}"
          echo "â„¹ï¸  OCI registries don't support 'latest' tags. Use --version ${{ steps.chart_version.outputs.version }}"

      - name: Verify Published Chart
        run: |
          echo "ðŸ” Verifying published chart..."
          helm show chart oci://${{ env.AR_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.CHART_NAME }} \
            --version ${{ steps.chart_version.outputs.version }} || \
          echo "âš ï¸  If verification fails, the chart may still be indexing. Wait a few seconds and try again."
          echo "âœ… Chart verification completed!"

      - name: Output Chart Information
        run: |
          CHART_REF="oci://${{ env.AR_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.CHART_NAME }}"
          echo "## ðŸ“¦ Helm Chart Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Chart:** \`${{ env.CHART_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.chart_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** \`${{ env.AR_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Access:** ðŸŒ Public (Open Source)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Install Command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# No authentication required (public chart)" >> $GITHUB_STEP_SUMMARY
          echo "helm install my-release $CHART_REF --version ${{ steps.chart_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Chart URL" >> $GITHUB_STEP_SUMMARY
          echo "\`$CHART_REF\`" >> $GITHUB_STEP_SUMMARY
