{{- if and .Values.controlPlane .Values.controlPlane.components .Values.controlPlane.components.api .Values.controlPlane.components.api.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: control-plane-api-health-check
  labels:
    app: control-plane-api
    component: health-check
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "helm.sh/hook-timeout": "90"
spec:
  backoffLimit: 0
  activeDeadlineSeconds: 90
  ttlSecondsAfterFinished: 0
  template:
    metadata:
      labels:
        app: control-plane-api
        component: health-check
    spec:
      restartPolicy: OnFailure
      containers:
      - name: health-check
        {{- /* Parse image and use helper function to add registry if needed */}}
        {{- $healthCheckRepo := "curlimages/curl" }}
        {{- $healthCheckTag := "8.13.0" }}
        image: {{ include "control-plane.image" (dict "repository" $healthCheckRepo "tag" $healthCheckTag "global" .Values.global) | quote }}
        command:
        - /bin/sh
        - -c
        - |
          set -e
          SERVICE_NAME="control-plane-api-service"
          SERVICE_NAMESPACE="{{ .Release.Namespace }}"
          SERVICE_URL="http://$SERVICE_NAME.$SERVICE_NAMESPACE.svc.cluster.local:80"
          MAX_ATTEMPTS=40
          ATTEMPT=0
          
          echo "Checking if service $SERVICE_NAME is ready..."
          echo "Service URL: $SERVICE_URL"
          
          # Try /health first, then root path
          HEALTH_URL="$SERVICE_URL/health"
          ROOT_URL="$SERVICE_URL/"
          
          # Quick check - try /health first, then root
          if curl -f -s -m 2 "$HEALTH_URL" > /dev/null 2>&1; then
            echo "✓ Health check passed immediately! Service /health endpoint is ready."
            exit 0
          elif curl -f -s -m 2 "$ROOT_URL" > /dev/null 2>&1; then
            echo "✓ Service check passed immediately! Service is responding on root path."
            exit 0
          fi
          
          echo "Service not ready yet, waiting for at least one pod to be ready..."
          
          # Wait for service to respond (checking every 2 seconds, max 80 seconds)
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -f -s -m 2 "$HEALTH_URL" > /dev/null 2>&1; then
              echo "✓ Health check passed! Service /health endpoint is ready."
              exit 0
            elif curl -f -s -m 2 "$ROOT_URL" > /dev/null 2>&1; then
              echo "✓ Service check passed! Service is responding on root path."
              exit 0
            fi
            ATTEMPT=$((ATTEMPT + 1))
            if [ $((ATTEMPT % 5)) -eq 0 ]; then
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Waiting for service to respond..."
            fi
            sleep 2
          done
          
          echo "ERROR: Service check failed after $MAX_ATTEMPTS attempts (~80 seconds)"
          echo "Service is not responding on /health or root path."
          echo "Please check pod logs and service status."
          exit 1
      {{- $imagePullSecret := "" }}
      {{- if .Values.imagePullSecrets }}
        {{- $imagePullSecret = .Values.imagePullSecrets }}
      {{- else if .Values.controlPlane }}
        {{- if hasKey .Values.controlPlane "imagePullSecrets" }}
          {{- if and .Values.controlPlane.imagePullSecrets (ne .Values.controlPlane.imagePullSecrets "none") (ne .Values.controlPlane.imagePullSecrets "") }}
            {{- $imagePullSecret = .Values.controlPlane.imagePullSecrets }}
          {{- end }}
        {{- end }}
      {{- end }}
      {{- if and $imagePullSecret (ne $imagePullSecret "none") (ne $imagePullSecret "") }}
      imagePullSecrets:
        - name: {{ $imagePullSecret }}
      {{- end }}
{{- end }}

