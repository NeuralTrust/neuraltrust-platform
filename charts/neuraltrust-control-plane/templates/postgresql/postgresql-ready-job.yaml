{{- if and .Values.controlPlane .Values.controlPlane.components .Values.controlPlane.components.postgresql .Values.controlPlane.components.postgresql.installInCluster }}
apiVersion: batch/v1
kind: Job
metadata:
  name: control-plane-postgresql-ready-check
  labels:
    app: control-plane-postgresql
    component: readiness-check
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-20"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "helm.sh/hook-timeout": "600"
spec:
  backoffLimit: 5
  activeDeadlineSeconds: 600
  template:
    metadata:
      labels:
        app: control-plane-postgresql
        component: readiness-check
    spec:
      restartPolicy: OnFailure
      containers:
      - name: postgresql-ready-check
        {{- $pgImageRepo := "postgres" }}
        {{- $pgImageTag := "17.2-alpine" }}
        {{- if and .Values.controlPlane .Values.controlPlane.components .Values.controlPlane.components.postgresql .Values.controlPlane.components.postgresql.image }}
          {{- if .Values.controlPlane.components.postgresql.image.repository }}{{- $pgImageRepo = .Values.controlPlane.components.postgresql.image.repository }}{{- end }}
          {{- if .Values.controlPlane.components.postgresql.image.tag }}{{- $pgImageTag = .Values.controlPlane.components.postgresql.image.tag }}{{- end }}
        {{- end }}
        image: {{ include "control-plane.image" (dict "repository" $pgImageRepo "tag" $pgImageTag "global" .Values.global) | quote }}
        command:
        - /bin/sh
        - -c
        - |
          set -e
          POSTGRES_HOST="control-plane-postgresql.{{ .Release.Namespace }}.svc.cluster.local"
          POSTGRES_PORT="5432"
          MAX_ATTEMPTS=240
          ATTEMPT=0
          
          echo "Waiting for PostgreSQL to be ready at $POSTGRES_HOST:$POSTGRES_PORT..."
          echo "This hook ensures PostgreSQL is ready before control-plane deployments start."
          
          # Wait for PostgreSQL service to be accessible and ready
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            # First check if the service endpoint is accessible
            if nc -z -w 2 "$POSTGRES_HOST" "$POSTGRES_PORT" 2>/dev/null; then
              echo "PostgreSQL service is accessible, verifying database is ready..."
              
              # Try to connect to PostgreSQL using pg_isready
              # pg_isready checks if PostgreSQL is accepting connections
              if pg_isready -h "$POSTGRES_HOST" -p "$POSTGRES_PORT" -t 2 >/dev/null 2>&1; then
                echo "âœ“ PostgreSQL is ready and accepting connections!"
                exit 0
              else
                echo "PostgreSQL port is open but not ready yet, waiting..."
              fi
            else
              echo "PostgreSQL service not accessible yet, waiting..."
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            if [ $((ATTEMPT % 10)) -eq 0 ]; then
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: PostgreSQL not ready yet, waiting..."
            fi
            sleep 2
          done
          
          echo "ERROR: PostgreSQL did not become ready at $POSTGRES_HOST:$POSTGRES_PORT within $((MAX_ATTEMPTS * 2)) seconds."
          echo "Check PostgreSQL pod logs and status for more information."
          exit 1
        env:
        - name: POSTGRES_HOST
          value: "control-plane-postgresql.{{ .Release.Namespace }}.svc.cluster.local"
        - name: POSTGRES_PORT
          value: "5432"
      {{- $pullSecrets := list }}
      {{- if and .Values.controlPlane (hasKey .Values.controlPlane "imagePullSecrets") .Values.controlPlane.imagePullSecrets }}
        {{- if kindIs "string" .Values.controlPlane.imagePullSecrets }}
          {{- if and .Values.controlPlane.imagePullSecrets (ne .Values.controlPlane.imagePullSecrets "") (ne .Values.controlPlane.imagePullSecrets "none") (gt (len (toString .Values.controlPlane.imagePullSecrets)) 0) }}
            {{- $pullSecrets = append $pullSecrets .Values.controlPlane.imagePullSecrets }}
          {{- end }}
        {{- else if kindIs "slice" .Values.controlPlane.imagePullSecrets }}
          {{- range .Values.controlPlane.imagePullSecrets }}
            {{- $secretName := "" }}
            {{- if kindIs "map" . }}
              {{- $secretName = .name | default "" }}
            {{- else if kindIs "string" . }}
              {{- $secretName = . }}
            {{- end }}
            {{- if and $secretName (ne $secretName "") (ne $secretName "none") (gt (len (toString $secretName)) 0) }}
              {{- $pullSecrets = append $pullSecrets $secretName }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
      {{- if gt (len $pullSecrets) 0 }}
      imagePullSecrets:
        {{- range $pullSecrets }}
        - name: {{ . }}
        {{- end }}
      {{- end }}
{{- end }}

