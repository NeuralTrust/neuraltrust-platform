{{- $secretName := "postgresql-secrets" }}
{{- if and .Values.controlPlane .Values.controlPlane.components .Values.controlPlane.components.postgresql .Values.controlPlane.components.postgresql.secrets .Values.controlPlane.components.postgresql.secrets.name }}
  {{- $secretName = .Values.controlPlane.components.postgresql.secrets.name }}
{{- end }}
{{- $existingSecret := (lookup "v1" "Secret" .Release.Namespace $secretName) }}
{{- /* Only create secret if it doesn't exist - secret is mandatory and should be created manually */}}
{{- if not $existingSecret }}
{{- /* Secret doesn't exist - create it with values from config (no defaults, values must be provided) */}}
{{- $pgUserValue := "" }}
{{- $pgPasswordValue := "" }}
{{- $pgDbValue := "" }}
{{- $pgHostValue := "" }}
{{- $pgPortValue := "5432" }}
{{- if and .Values.controlPlane .Values.controlPlane.components .Values.controlPlane.components.postgresql .Values.controlPlane.components.postgresql.secrets }}
  {{- if .Values.controlPlane.components.postgresql.secrets.user }}{{- $pgUserValue = .Values.controlPlane.components.postgresql.secrets.user }}{{- end }}
  {{- if .Values.controlPlane.components.postgresql.secrets.password }}{{- $pgPasswordValue = .Values.controlPlane.components.postgresql.secrets.password }}{{- end }}
  {{- if .Values.controlPlane.components.postgresql.secrets.database }}{{- $pgDbValue = .Values.controlPlane.components.postgresql.secrets.database }}{{- end }}
  {{- if .Values.controlPlane.components.postgresql.secrets.host }}{{- $pgHostValue = .Values.controlPlane.components.postgresql.secrets.host }}{{- end }}
  {{- if .Values.controlPlane.components.postgresql.secrets.port }}{{- $pgPortValue = .Values.controlPlane.components.postgresql.secrets.port | toString }}{{- end }}
{{- end }}
{{- /* Compute raw values for connection strings */}}
{{- $pgUser := include "control-plane.getSecretValueRaw" (dict "value" $pgUserValue "secretName" $secretName "secretKey" "POSTGRES_USER" "context" $) }}
{{- $pgPassword := include "control-plane.getSecretValueRaw" (dict "value" $pgPasswordValue "secretName" $secretName "secretKey" "POSTGRES_PASSWORD" "context" $) }}
{{- $pgHost := include "control-plane.getSecretValueRaw" (dict "value" $pgHostValue "secretName" $secretName "secretKey" "POSTGRES_HOST" "context" $) }}
{{- $pgPort := include "control-plane.getSecretValueRaw" (dict "value" $pgPortValue "secretName" $secretName "secretKey" "POSTGRES_PORT" "context" $) }}
{{- $pgDb := include "control-plane.getSecretValueRaw" (dict "value" $pgDbValue "secretName" $secretName "secretKey" "POSTGRES_DB" "context" $) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace }}
type: Opaque
data:
  POSTGRES_USER: {{ include "control-plane.getSecretValue" (dict "value" $pgUserValue "secretName" $secretName "secretKey" "POSTGRES_USER" "context" $) }}
  POSTGRES_PASSWORD: {{ include "control-plane.getSecretValue" (dict "value" $pgPasswordValue "secretName" $secretName "secretKey" "POSTGRES_PASSWORD" "context" $) }}
  POSTGRES_DB: {{ include "control-plane.getSecretValue" (dict "value" $pgDbValue "secretName" $secretName "secretKey" "POSTGRES_DB" "context" $) }}
  POSTGRES_HOST: {{ include "control-plane.getSecretValue" (dict "value" $pgHostValue "secretName" $secretName "secretKey" "POSTGRES_HOST" "context" $) }}
  POSTGRES_PORT: {{ include "control-plane.getSecretValue" (dict "value" $pgPortValue "secretName" $secretName "secretKey" "POSTGRES_PORT" "context" $) }}
  {{- $sslMode := "require" }}
  {{- if and .Values.controlPlane .Values.controlPlane.components .Values.controlPlane.components.postgresql .Values.controlPlane.components.postgresql.installInCluster }}
    {{- $sslMode = "disable" }}
  {{- end }}
  DATABASE_URL: {{ printf "postgresql://%s:%s@%s:%s/%s?connection_limit=15&sslmode=%s" $pgUser ($pgPassword | urlquery) $pgHost $pgPort $pgDb $sslMode | b64enc }}
  POSTGRES_PRISMA_URL: {{ printf "postgresql://%s:%s@%s:%s/%s?connection_limit=15&sslmode=%s" $pgUser ($pgPassword | urlquery) $pgHost $pgPort $pgDb $sslMode | b64enc }}
{{- end }}
