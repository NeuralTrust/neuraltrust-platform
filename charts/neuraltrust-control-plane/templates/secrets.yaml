{{- $secretName := "control-plane-secrets" }}
{{- $existingSecret := (lookup "v1" "Secret" .Release.Namespace $secretName) }}
{{- /* Check if secret already exists - if so, skip creation to allow pre-created secrets */}}
{{- /* Only create/update the secret from values if they are provided AND secret doesn't exist */}}
{{- $hasValues := false }}
{{- if and .Values.controlPlane .Values.controlPlane.secrets }}
  {{- if or .Values.controlPlane.secrets.controlPlaneJWTSecret .Values.controlPlane.secrets.openaiApiKey .Values.controlPlane.secrets.resendApiKey .Values.controlPlane.secrets.resendAlertSender .Values.controlPlane.secrets.resendInviteSender .Values.controlPlane.secrets.trustgateJwtSecret .Values.controlPlane.secrets.firewallJwtSecret .Values.controlPlane.secrets.modelScannerSecret }}
    {{- $hasValues = true }}
  {{- end }}
{{- end }}
{{- /* Create secret if it doesn't exist AND values are provided (skip if secret already exists to allow pre-created secrets) */}}
{{- if and (not $existingSecret) $hasValues }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace }}
type: Opaque
data:
  # Control Plane JWT Secret
  # Supports both direct value or secret reference: {secretName: "my-secret", secretKey: "CONTROL_PLANE_JWT_SECRET"}
  {{- $jwtSecret := "" }}
  {{- if and .Values.controlPlane .Values.controlPlane.secrets .Values.controlPlane.secrets.controlPlaneJWTSecret }}
    {{- $jwtSecret = .Values.controlPlane.secrets.controlPlaneJWTSecret }}
  {{- end }}
  CONTROL_PLANE_JWT_SECRET: {{ include "control-plane.getSecretValue" (dict "value" $jwtSecret "secretName" $secretName "secretKey" "CONTROL_PLANE_JWT_SECRET" "context" $) }}
  
  # OpenAI API Key
  # Supports both direct value or secret reference: {secretName: "my-secret", secretKey: "OPENAI_API_KEY"}
  {{- $openaiKey := "" }}
  {{- if and .Values.controlPlane .Values.controlPlane.secrets .Values.controlPlane.secrets.openaiApiKey }}
    {{- $openaiKey = .Values.controlPlane.secrets.openaiApiKey }}
  {{- end }}
  OPENAI_API_KEY: {{ include "control-plane.getSecretValue" (dict "value" $openaiKey "secretName" $secretName "secretKey" "OPENAI_API_KEY" "context" $) }}
  
  # Resend API secrets
  # Supports both direct value or secret reference: {secretName: "my-secret", secretKey: "resend-api-key"}
  {{- $resendKey := "" }}
  {{- if and .Values.controlPlane .Values.controlPlane.secrets .Values.controlPlane.secrets.resendApiKey }}
    {{- $resendKey = .Values.controlPlane.secrets.resendApiKey }}
  {{- end }}
  resend-api-key: {{ include "control-plane.getSecretValue" (dict "value" $resendKey "secretName" $secretName "secretKey" "resend-api-key" "context" $) }}
  {{- $resendAlert := "" }}
  {{- if and .Values.controlPlane .Values.controlPlane.secrets .Values.controlPlane.secrets.resendAlertSender }}
    {{- $resendAlert = .Values.controlPlane.secrets.resendAlertSender }}
  {{- end }}
  resend-alert-sender: {{ include "control-plane.getSecretValue" (dict "value" $resendAlert "secretName" $secretName "secretKey" "resend-alert-sender" "context" $) }}
  {{- $resendInvite := "" }}
  {{- if and .Values.controlPlane .Values.controlPlane.secrets .Values.controlPlane.secrets.resendInviteSender }}
    {{- $resendInvite = .Values.controlPlane.secrets.resendInviteSender }}
  {{- end }}
  resend-invite-sender: {{ include "control-plane.getSecretValue" (dict "value" $resendInvite "secretName" $secretName "secretKey" "resend-invite-sender" "context" $) }}
  
  # Trustgate JWT Secret
  # Supports both direct value or secret reference: {secretName: "my-secret", secretKey: "TRUSTGATE_JWT_SECRET"}
  {{- $trustgateJwt := "" }}
  {{- if and .Values.controlPlane .Values.controlPlane.secrets .Values.controlPlane.secrets.trustgateJwtSecret }}
    {{- $trustgateJwt = .Values.controlPlane.secrets.trustgateJwtSecret }}
  {{- end }}
  TRUSTGATE_JWT_SECRET: {{ include "control-plane.getSecretValue" (dict "value" $trustgateJwt "secretName" $secretName "secretKey" "TRUSTGATE_JWT_SECRET" "context" $) }}
  
  # Firewall JWT Secret (optional - if not provided, will use DATA_PLANE_JWT_SECRET as fallback)
  # Supports both direct value or secret reference: {secretName: "my-secret", secretKey: "FIREWALL_JWT_SECRET"}
  {{- if and .Values.controlPlane .Values.controlPlane.secrets .Values.controlPlane.secrets.firewallJwtSecret (or (kindIs "map" .Values.controlPlane.secrets.firewallJwtSecret) (and (kindIs "string" .Values.controlPlane.secrets.firewallJwtSecret) (ne .Values.controlPlane.secrets.firewallJwtSecret ""))) }}
  FIREWALL_JWT_SECRET: {{ include "control-plane.getSecretValue" (dict "value" .Values.controlPlane.secrets.firewallJwtSecret "secretName" $secretName "secretKey" "FIREWALL_JWT_SECRET" "context" $) }}
  {{- end }}
  
  # Model Scanner Secret
  # Supports both direct value or secret reference: {secretName: "my-secret", secretKey: "MODEL_SCANNER_SECRET"}
  {{- $modelScanner := "" }}
  {{- if and .Values.controlPlane .Values.controlPlane.secrets .Values.controlPlane.secrets.modelScannerSecret }}
    {{- $modelScanner = .Values.controlPlane.secrets.modelScannerSecret }}
  {{- end }}
  MODEL_SCANNER_SECRET: {{ include "control-plane.getSecretValue" (dict "value" $modelScanner "secretName" $secretName "secretKey" "MODEL_SCANNER_SECRET" "context" $) }}
{{- end }}
