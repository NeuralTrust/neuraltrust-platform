{{- with .Values.dataPlane }}
  {{- with .components }}
    {{- with .api }}
      {{- if .enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: data-plane-api-health-check
  labels:
    app: data-plane-api
    component: health-check
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "helm.sh/hook-timeout": "90"
spec:
  backoffLimit: 0
  activeDeadlineSeconds: 90
  ttlSecondsAfterFinished: 0
  template:
    metadata:
      labels:
        app: data-plane-api
        component: health-check
    spec:
      restartPolicy: OnFailure
      containers:
      - name: health-check
        {{- $healthCheckImage := "curlimages/curl:8.13.0" }}
        {{- if and $.Values.dataPlane $.Values.dataPlane.components $.Values.dataPlane.components.connectorsJob $.Values.dataPlane.components.connectorsJob.image }}
          {{- $healthCheckImage = toString $.Values.dataPlane.components.connectorsJob.image }}
        {{- end }}
        {{- /* If image already contains registry (has a dot), use as-is, otherwise use helper */}}
        {{- $parts := splitList ":" $healthCheckImage }}
        {{- $healthCheckRepo := index $parts 0 }}
        {{- $healthCheckTag := index $parts 1 | default "latest" }}
        {{- $finalImage := "" }}
        {{- if and $.Values.global.imageRegistry (contains "." $healthCheckRepo) }}
          {{- /* Image already has registry prefix, use directly */}}
          {{- $finalImage = $healthCheckImage }}
        {{- else }}
          {{- /* Use helper function to add registry if needed */}}
          {{- $finalImage = include "data-plane.image" (dict "repository" $healthCheckRepo "tag" $healthCheckTag "global" $.Values.global) }}
        {{- end }}
        image: {{ $finalImage | quote }}
        command:
        - /bin/sh
        - -c
        - |
          set -e
          SERVICE_NAME="data-plane-api-service"
          SERVICE_NAMESPACE="{{ $.Release.Namespace }}"
          SERVICE_URL="http://$SERVICE_NAME.$SERVICE_NAMESPACE.svc.cluster.local/health"
          MAX_ATTEMPTS=40
          ATTEMPT=0
          
          echo "Checking if service $SERVICE_NAME is ready..."
          echo "Health endpoint: $SERVICE_URL"
          
          # Quick check - if health endpoint responds immediately, exit successfully
          if curl -f -s -m 2 "$SERVICE_URL" > /dev/null 2>&1; then
            echo "✓ Health check passed immediately! Service is ready."
            exit 0
          fi
          
          echo "Service not ready yet, waiting for at least one pod to be ready..."
          
          # Wait for health endpoint to respond (checking every 2 seconds, max 80 seconds)
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -f -s -m 2 "$SERVICE_URL" > /dev/null 2>&1; then
              echo "✓ Health check passed! Service is ready and responding."
              exit 0
            fi
            ATTEMPT=$((ATTEMPT + 1))
            if [ $((ATTEMPT % 5)) -eq 0 ]; then
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Waiting for health endpoint..."
            fi
            sleep 2
          done
          
          echo "INFO: Health check did not pass after $MAX_ATTEMPTS attempts (~80 seconds)"
          echo "If at least one pod is running, deployment will continue."
          echo "Remaining pods will scale up in background."
          # Exit with success to allow deployment to continue - don't block on health check
          exit 0
      {{- if $.Values.dataPlane.imagePullSecrets }}
      imagePullSecrets:
        {{- if kindIs "string" $.Values.dataPlane.imagePullSecrets }}
        - name: {{ $.Values.dataPlane.imagePullSecrets }}
        {{- else if kindIs "slice" $.Values.dataPlane.imagePullSecrets }}
        {{- toYaml $.Values.dataPlane.imagePullSecrets | nindent 8 }}
        {{- end }}
      {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

