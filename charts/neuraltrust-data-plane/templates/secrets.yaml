{{- $secretName := "data-plane-jwt-secret" }}
{{- if and .Values.dataPlane .Values.dataPlane.secrets .Values.dataPlane.secrets.dataPlaneJWTSecretName }}
{{- $secretName = .Values.dataPlane.secrets.dataPlaneJWTSecretName }}
{{- end }}
{{- /* Check if parent chart handles secret creation via autoGenerateSecrets */}}
{{- $parentManagesSecrets := false }}
{{- if and $.Values.global (hasKey $.Values.global "autoGenerateSecrets") $.Values.global.autoGenerateSecrets }}
  {{- $parentManagesSecrets = true }}
{{- end }}
{{- /* Check preserveExistingSecrets flag - if true, skip secret creation (secrets are pre-generated) */}}
{{- $preserveSecrets := false }}
{{- if $.Values.global }}
  {{- if hasKey $.Values.global "preserveExistingSecrets" }}
    {{- if $.Values.global.preserveExistingSecrets }}
      {{- $preserveSecrets = true }}
    {{- end }}
  {{- end }}
{{- end }}
{{- $existingSecret := (lookup "v1" "Secret" .Release.Namespace $secretName) }}
{{- $jwtSecretValue := "" }}
{{- if and .Values.dataPlane .Values.dataPlane.secrets .Values.dataPlane.secrets.dataPlaneJWTSecret }}
  {{- $jwtSecretValue = .Values.dataPlane.secrets.dataPlaneJWTSecret }}
{{- end }}
{{- /* Skip if parent chart manages secrets OR preserveExistingSecrets is true */}}
{{- /* When parent manages: autoGenerateSecrets: true → parent chart creates this secret */}}
{{- /* When preserveExistingSecrets: true → skip entirely (secrets are pre-generated) */}}
{{- if and (not $parentManagesSecrets) (not $preserveSecrets) $jwtSecretValue }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "neuraltrust-data-plane.labels" . | nindent 4 }}
type: Opaque
data:
  # Supports both direct value or secret reference: {secretName: "my-secret", secretKey: "DATA_PLANE_JWT_SECRET"}
  DATA_PLANE_JWT_SECRET: {{ include "data-plane.getSecretValue" (dict "value" $jwtSecretValue "secretName" $secretName "secretKey" "DATA_PLANE_JWT_SECRET" "context" $) }}
{{- end }}
---
{{- if and .Values.dataPlane .Values.dataPlane.secrets .Values.dataPlane.secrets.openaiApiKey }}
{{- $secretName := "openai-secrets" }}
{{- if and .Values.dataPlane .Values.dataPlane.secrets .Values.dataPlane.secrets.openaiApiKeySecretName }}
{{- $secretName = .Values.dataPlane.secrets.openaiApiKeySecretName }}
{{- end }}
{{- $preserveSecrets := false }}
{{- if $.Values.global }}
  {{- if hasKey $.Values.global "preserveExistingSecrets" }}
    {{- if $.Values.global.preserveExistingSecrets }}
      {{- $preserveSecrets = true }}
    {{- end }}
  {{- end }}
{{- end }}
{{- $existingSecret := (lookup "v1" "Secret" .Release.Namespace $secretName) }}
{{- /* Create/update secret if preserveExistingSecrets is false */}}
{{- /* When preserveExistingSecrets: false, Helm will create or update the secret */}}
{{- /* When preserveExistingSecrets: true, skip entirely (secrets are pre-generated) */}}
{{- if not $preserveSecrets }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "neuraltrust-data-plane.labels" . | nindent 4 }}
type: Opaque
data:
  # Supports both direct value or secret reference: {secretName: "my-secret", secretKey: "OPENAI_API_KEY"}
  OPENAI_API_KEY: {{ include "data-plane.getSecretValue" (dict "value" .Values.dataPlane.secrets.openaiApiKey "secretName" $secretName "secretKey" "OPENAI_API_KEY" "context" $) }}
{{- end }}
{{- end }}
---
{{- if and .Values.dataPlane .Values.dataPlane.secrets .Values.dataPlane.secrets.googleApiKey }}
{{- $secretName := "google-secrets" }}
{{- if and .Values.dataPlane .Values.dataPlane.secrets .Values.dataPlane.secrets.googleApiKeySecretName }}
{{- $secretName = .Values.dataPlane.secrets.googleApiKeySecretName }}
{{- end }}
{{- $preserveSecrets := false }}
{{- if $.Values.global }}
  {{- if hasKey $.Values.global "preserveExistingSecrets" }}
    {{- if $.Values.global.preserveExistingSecrets }}
      {{- $preserveSecrets = true }}
    {{- end }}
  {{- end }}
{{- end }}
{{- $existingSecret := (lookup "v1" "Secret" .Release.Namespace $secretName) }}
{{- /* Create/update secret if preserveExistingSecrets is false */}}
{{- /* When preserveExistingSecrets: false, Helm will create or update the secret */}}
{{- /* When preserveExistingSecrets: true, skip entirely (secrets are pre-generated) */}}
{{- if not $preserveSecrets }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "neuraltrust-data-plane.labels" . | nindent 4 }}
type: Opaque
data:
  # Supports both direct value or secret reference: {secretName: "my-secret", secretKey: "GOOGLE_API_KEY"}
  GOOGLE_API_KEY: {{ include "data-plane.getSecretValue" (dict "value" .Values.dataPlane.secrets.googleApiKey "secretName" $secretName "secretKey" "GOOGLE_API_KEY" "context" $) }}
{{- end }}
{{- end }}
---
{{- if and .Values.dataPlane .Values.dataPlane.secrets .Values.dataPlane.secrets.resendApiKey }}
{{- $secretName := "resend-secrets" }}
{{- if and .Values.dataPlane .Values.dataPlane.secrets .Values.dataPlane.secrets.resendApiKeySecretName }}
{{- $secretName = .Values.dataPlane.secrets.resendApiKeySecretName }}
{{- end }}
{{- $preserveSecrets := false }}
{{- if $.Values.global }}
  {{- if hasKey $.Values.global "preserveExistingSecrets" }}
    {{- if $.Values.global.preserveExistingSecrets }}
      {{- $preserveSecrets = true }}
    {{- end }}
  {{- end }}
{{- end }}
{{- $existingSecret := (lookup "v1" "Secret" .Release.Namespace $secretName) }}
{{- /* Create/update secret if preserveExistingSecrets is false */}}
{{- /* When preserveExistingSecrets: false, Helm will create or update the secret */}}
{{- /* When preserveExistingSecrets: true, skip entirely (secrets are pre-generated) */}}
{{- if not $preserveSecrets }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "neuraltrust-data-plane.labels" . | nindent 4 }}
type: Opaque
data:
  # Supports both direct value or secret reference: {secretName: "my-secret", secretKey: "RESEND_API_KEY"}
  RESEND_API_KEY: {{ include "data-plane.getSecretValue" (dict "value" .Values.dataPlane.secrets.resendApiKey "secretName" $secretName "secretKey" "RESEND_API_KEY" "context" $) }}
{{- end }}
{{- end }} 
---
{{- if and .Values.dataPlane .Values.dataPlane.secrets .Values.dataPlane.secrets.huggingFaceToken }}
{{- $secretName := "huggingface-secrets" }}
{{- if and .Values.dataPlane .Values.dataPlane.secrets .Values.dataPlane.secrets.huggingFaceTokenSecretName }}
{{- $secretName = .Values.dataPlane.secrets.huggingFaceTokenSecretName }}
{{- end }}
{{- $preserveSecrets := false }}
{{- if $.Values.global }}
  {{- if hasKey $.Values.global "preserveExistingSecrets" }}
    {{- if $.Values.global.preserveExistingSecrets }}
      {{- $preserveSecrets = true }}
    {{- end }}
  {{- end }}
{{- end }}
{{- $existingSecret := (lookup "v1" "Secret" .Release.Namespace $secretName) }}
{{- /* Create/update secret if preserveExistingSecrets is false */}}
{{- /* When preserveExistingSecrets: false, Helm will create or update the secret */}}
{{- /* When preserveExistingSecrets: true, skip entirely (secrets are pre-generated) */}}
{{- if not $preserveSecrets }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "neuraltrust-data-plane.labels" . | nindent 4 }}
type: Opaque
data:
  # Supports both direct value or secret reference: {secretName: "my-secret", secretKey: "HUGGINGFACE_TOKEN"}
  HUGGINGFACE_TOKEN: {{ include "data-plane.getSecretValue" (dict "value" .Values.dataPlane.secrets.huggingFaceToken "secretName" $secretName "secretKey" "HUGGINGFACE_TOKEN" "context" $) }}
{{- end }}
{{- end }} 