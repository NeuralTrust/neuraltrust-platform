{{- $secretName := "trustgate-secrets" }}
{{- /* Check if secret already exists - if so, skip creation to allow pre-created secrets */}}
{{- $existingSecret := (lookup "v1" "Secret" .Release.Namespace $secretName) }}
{{- /* Get database values from trustgate.global.env, with fallback to control-plane PostgreSQL if available */}}
{{- $dbHost := "" }}
{{- $dbPort := "5432" }}
{{- $dbUser := "postgres" }}
{{- $dbPassword := "" }}
{{- $dbName := "trustgate" }}
{{- $dbSslMode := "require" }}
{{- if and .Values.global.env .Values.global.env.DATABASE_HOST (ne .Values.global.env.DATABASE_HOST "") }}
  {{- $dbHost = .Values.global.env.DATABASE_HOST }}
{{- end }}
{{- if and .Values.global.env .Values.global.env.DATABASE_PORT (ne .Values.global.env.DATABASE_PORT "") }}
  {{- $dbPort = .Values.global.env.DATABASE_PORT | toString }}
{{- end }}
{{- if and .Values.global.env .Values.global.env.DATABASE_USER (ne .Values.global.env.DATABASE_USER "") }}
  {{- $dbUser = .Values.global.env.DATABASE_USER }}
{{- end }}
{{- if and .Values.global.env .Values.global.env.DATABASE_PASSWORD (ne .Values.global.env.DATABASE_PASSWORD "") }}
  {{- $dbPassword = .Values.global.env.DATABASE_PASSWORD }}
{{- end }}
{{- if and .Values.global.env .Values.global.env.DATABASE_NAME (ne .Values.global.env.DATABASE_NAME "") }}
  {{- $dbName = .Values.global.env.DATABASE_NAME }}
{{- end }}
{{- if and .Values.global.env .Values.global.env.DATABASE_SSL_MODE (ne .Values.global.env.DATABASE_SSL_MODE "") }}
  {{- $dbSslMode = .Values.global.env.DATABASE_SSL_MODE }}
{{- end }}
{{- /* Only create secret if we have required values (host and password) AND secret doesn't already exist */}}
{{- if and (not $existingSecret) $dbHost $dbPassword }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "trustgate.labels" . | nindent 4 }}
type: Opaque
data:
  {{- range $provider, $config := .Values.config.providers }}
  {{- if $config.apiKey }}
  {{ $provider }}-api-key: {{ $config.apiKey | b64enc | quote }}
  {{- end }}
  {{- end }}
  redis-password: {{ .Values.redis.auth.password | default (randAlphaNum 32) | b64enc | quote }}
  DATABASE_HOST: {{ $dbHost | b64enc | quote }}
  DATABASE_PORT: {{ $dbPort | b64enc | quote }}
  DATABASE_USER: {{ $dbUser | b64enc | quote }}
  DATABASE_PASSWORD: {{ $dbPassword | b64enc | quote }}
  DATABASE_NAME: {{ $dbName | b64enc | quote }}
  {{- $dbUrl := printf "postgresql://%s:%s@%s:%s/%s?sslmode=%s" $dbUser ($dbPassword | urlquery) $dbHost $dbPort $dbName $dbSslMode }}
  DATABASE_URL: {{ $dbUrl | b64enc | quote }}
  {{- if and .Values.global.env .Values.global.env.SERVER_SECRET_KEY .Values.global.env.SERVER_SECRET_KEY }}
  SERVER_SECRET_KEY: {{ .Values.global.env.SERVER_SECRET_KEY | b64enc | quote }}
  {{- end }}
{{- end }}

{{- if .Values.certManager.customCertificates.enabled }}
---
# Control Plane custom certificate
apiVersion: v1
kind: Secret
metadata:
  name: trustgate-admin-tls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "trustgate.labels" . | nindent 4 }}
type: kubernetes.io/tls
data:
  tls.crt: {{ .Values.certManager.customCertificates.controlPlane.cert | b64enc }}
  tls.key: {{ .Values.certManager.customCertificates.controlPlane.key | b64enc }}
---
# Data Plane custom certificate
apiVersion: v1
kind: Secret
metadata:
  name: trustgate-gateway-tls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "trustgate.labels" . | nindent 4 }}
type: kubernetes.io/tls
data:
  tls.crt: {{ .Values.certManager.customCertificates.dataPlane.cert | b64enc }}
  tls.key: {{ .Values.certManager.customCertificates.dataPlane.key | b64enc }}
{{- end }}