{{- $secretName := "trustgate-secrets" }}
{{- /* Check if parent chart handles secret creation via autoGenerateSecrets */}}
{{- $parentManagesSecrets := false }}
{{- if and $.Values.global (hasKey $.Values.global "autoGenerateSecrets") $.Values.global.autoGenerateSecrets }}
  {{- $parentManagesSecrets = true }}
{{- end }}
{{- /* Check preserveExistingSecrets flag - if true, skip secret creation (secrets are pre-generated) */}}
{{- $preserveSecrets := false }}
{{- if $.Values.global }}
  {{- if hasKey $.Values.global "preserveExistingSecrets" }}
    {{- if $.Values.global.preserveExistingSecrets }}
      {{- $preserveSecrets = true }}
    {{- end }}
  {{- end }}
{{- end }}
{{- /* Skip if parent chart manages secrets OR preserveExistingSecrets is true */}}
{{- if and (not $parentManagesSecrets) (not $preserveSecrets) }}
{{- /* Get database values from trustgate.global.env, with fallback to control-plane PostgreSQL if available */}}
{{- $dbHost := "" }}
{{- $dbPort := "5432" }}
{{- $dbUser := "trustgate" }}
{{- $dbPassword := "" }}
{{- $dbName := "trustgate" }}
{{- $dbSslMode := "disable" }}
{{- if and .Values.global.env .Values.global.env.DATABASE_HOST (ne .Values.global.env.DATABASE_HOST "") }}
  {{- $dbHost = .Values.global.env.DATABASE_HOST }}
{{- end }}
{{- if and .Values.global.env .Values.global.env.DATABASE_PORT (ne .Values.global.env.DATABASE_PORT "") }}
  {{- $dbPort = .Values.global.env.DATABASE_PORT | toString }}
{{- end }}
{{- if and .Values.global.env .Values.global.env.DATABASE_USER (ne .Values.global.env.DATABASE_USER "") }}
  {{- $dbUser = .Values.global.env.DATABASE_USER }}
{{- end }}
{{- if and .Values.global.env .Values.global.env.DATABASE_PASSWORD (ne .Values.global.env.DATABASE_PASSWORD "") }}
  {{- $dbPassword = .Values.global.env.DATABASE_PASSWORD }}
{{- end }}
{{- if and .Values.global.env .Values.global.env.DATABASE_NAME (ne .Values.global.env.DATABASE_NAME "") }}
  {{- $dbName = .Values.global.env.DATABASE_NAME }}
{{- end }}
{{- if and .Values.global.env .Values.global.env.DATABASE_SSL_MODE (ne .Values.global.env.DATABASE_SSL_MODE "") }}
  {{- $dbSslMode = .Values.global.env.DATABASE_SSL_MODE }}
{{- end }}
{{- /* TrustGate secrets are mandatory when TrustGate is enabled */}}
{{- /* This chart is only included when trustgate.enabled: true, so we should always create the secret */}}
{{- /* However, we need DATABASE_HOST and DATABASE_PASSWORD to be set */}}
{{- if not $dbHost }}
{{- fail "trustgate.global.env.DATABASE_HOST is required when trustgate.enabled: true" }}
{{- end }}
{{- if not $dbPassword }}
{{- fail "trustgate.global.env.DATABASE_PASSWORD is required when trustgate.enabled: true (or set global.autoGenerateSecrets: true)" }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
  labels:
    {{- include "trustgate.labels" . | nindent 4 }}
type: Opaque
data:
  {{- range $provider, $config := .Values.config.providers }}
  {{- if $config.apiKey }}
  {{ $provider }}-api-key: {{ $config.apiKey | b64enc | quote }}
  {{- end }}
  {{- end }}
  DATABASE_HOST: {{ $dbHost | b64enc | quote }}
  DATABASE_PORT: {{ $dbPort | b64enc | quote }}
  DATABASE_USER: {{ $dbUser | b64enc | quote }}
  DATABASE_PASSWORD: {{ $dbPassword | b64enc | quote }}
  DATABASE_NAME: {{ $dbName | b64enc | quote }}
  DATABASE_SSL_MODE: {{ $dbSslMode | b64enc | quote }}
  {{- $dbUrl := printf "postgresql://%s:%s@%s:%s/%s?sslmode=%s" $dbUser ($dbPassword | urlquery) $dbHost $dbPort $dbName $dbSslMode }}
  DATABASE_URL: {{ $dbUrl | b64enc | quote }}
  {{- if and .Values.global.env .Values.global.env.SERVER_SECRET_KEY .Values.global.env.SERVER_SECRET_KEY }}
  SERVER_SECRET_KEY: {{ .Values.global.env.SERVER_SECRET_KEY | b64enc | quote }}
  {{- end }}
{{- end }}
{{- /* End of autoGenerateSecrets / preserveExistingSecrets check */}}

{{- if .Values.certManager.customCertificates.enabled }}
---
# Control Plane custom certificate
apiVersion: v1
kind: Secret
metadata:
  name: trustgate-admin-tls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "trustgate.labels" . | nindent 4 }}
type: kubernetes.io/tls
data:
  tls.crt: {{ .Values.certManager.customCertificates.controlPlane.cert | b64enc }}
  tls.key: {{ .Values.certManager.customCertificates.controlPlane.key | b64enc }}
---
# Data Plane custom certificate
apiVersion: v1
kind: Secret
metadata:
  name: trustgate-gateway-tls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "trustgate.labels" . | nindent 4 }}
type: kubernetes.io/tls
data:
  tls.crt: {{ .Values.certManager.customCertificates.dataPlane.cert | b64enc }}
  tls.key: {{ .Values.certManager.customCertificates.dataPlane.key | b64enc }}
{{- end }}